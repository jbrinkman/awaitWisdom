WriteFileName: feed.atom
---
@using System.ServiceModel.Syndication; 
@using System.IO;
@using System.Xml;
@using AngleSharp;
@using AngleSharp.Parser.Html;

@{
	Layout = string.Empty;
	
	Uri baseUri = new Uri(@"http://blog.awaitWisdom.com");
    SyndicationFeed feed = new SyndicationFeed()
    {
        Title = new TextSyndicationContent("await Wisdom()"),
        Description = new TextSyndicationContent("Latest blog posts by Josh Gillespie"),
        BaseUri = baseUri,
        Items = Documents
            .Where(x => x.ContainsKey("Published") && x.Get<DateTimeOffset>("Published") <= System.DateTimeOffset.Now)
            .OrderByDescending(x => x.Get<DateTimeOffset>("Published"))
            .Take(10)
            .Select(x => {             
                Uri uri = new Uri(baseUri, "/" + PathHelper.RemoveExtension(x.String("RelativeFilePath")).Replace("\\", "/"));
                SyndicationItem item = new SyndicationItem(
                    x.String("Title") + (x.ContainsKey("Lead") ? " - " + x.String("Lead") : string.Empty),
                    x.String("PostContent"),
                    uri, uri.ToString(), x.ContainsKey("Edited") ? x.Get<DateTimeOffset>("Edited") : x.Get<DateTimeOffset>("Published"))
                {
                    PublishDate = x.Get<DateTimeOffset>("Published")
                };

                item.Authors.Add(new SyndicationPerson("", "Josh Gillespie", ""));
                return item;
            })
    };
    feed.Links.Add(new SyndicationLink(feed.BaseUri));
    using (XmlTextWriter writer = new XmlTextWriter(Output))
    {
        new Atom10FeedFormatter(feed).WriteTo(writer);
    }        
}